<app-card id="converter" title="üìÖ Calendar Converter App">
  <!-- Auth Required Message (when not authenticated) -->
  @if (!isAuthLoading && !isAuthenticated) {
    <section class="auth-required" aria-labelledby="auth-heading">
      <div class="auth-message">
        <h3 id="auth-heading" class="sr-only">AI Calendar Converter</h3>
        <p>
          Upload or snap your appointments, and AI turns them into calendar-ready events.
        </p>
        <img 
          src="/assets/images/converter.png" 
          alt="Calendar converter illustration" 
          class="auth-image" 
          loading="lazy"
          appTooltip="AI-powered calendar conversion"
          appTooltipPlacement="bottom"
        />
      </div>
      <button class="sign-in-button btn btn-primary btn-lg" (click)="signIn()" aria-label="Sign in with Google to use converter">
        üîê Sign in with Google
      </button>
    </section>
  }

  <!-- Loading State -->
  @if (isAuthLoading) {
    <div class="auth-loading" role="status" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <p>Loading...</p>
    </div>
  }

  <!-- Converter UI (only shown when authenticated) -->
  @if (!isAuthLoading && isAuthenticated) {
    <!-- Upload Area - Only show if no events extracted -->
    @if (extractedEvents().length === 0) {
      <section class="upload-zone"
        [class.dragging]="isDragging()"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        role="region"
        aria-labelledby="upload-heading"
        appTooltip="Drag and drop your files or click to browse"
        appTooltipPlacement="top"
      >
        <div class="marketing-text">
          <h4>Save time creating calendar events.</h4>
          <h4>AI will do the work for you!</h4>
        </div>
        <div class="upload-icon" aria-hidden="true">üì§</div>
        <h3 id="upload-heading" class="sr-only">Upload Files</h3>
        <p>Drop photos, images, or PDFs here or</p>
        <label class="upload-button">
          <input
            type="file"
            class="file-input"
            multiple
            accept="image/jpeg,image/jpg,image/png,application/pdf"
            (change)="onFileSelect($event)"
            [disabled]="isProcessing()"
            aria-label="Select files to upload"
          />
          <span>Browse</span>
        </label>
      </section>

      <!-- Selected Files - Minimalist -->
      @if (files().length > 0) {
        <div class="selected-files" role="list" aria-label="Selected files">
          @for (file of files(); track $index) {
            <div class="file-chip" role="listitem">
              <span>{{ file.name }}</span>
              <button
                class="chip-remove"
                (click)="removeFile($index)"
                [disabled]="isProcessing()"
                [attr.aria-label]="'Remove ' + file.name"
                appTooltip="Remove file"
                appTooltipPlacement="top"
              >
                ‚úï
              </button>
            </div>
          }
        </div>
      }

      <!-- Convert Button -->
      @if (files().length > 0 && !isProcessing()) {
        <button
          class="action-button btn btn-primary"
          (click)="convertToIcs()"
          aria-label="Convert files to calendar events"
          appTooltip="Convert your files to calendar events"
          appTooltipPlacement="top"
        >
          Convert
        </button>
      }

      @if (isProcessing()) {
        <div class="processing" role="status" aria-live="polite">
          <span class="spinner" aria-hidden="true"></span>
          @if (isBatchMode()) {
            <div class="batch-processing">
              <span>Processing files: {{ batchStats().processing + batchStats().success }} / {{ batchStats().total }}</span>
              <ngb-progressbar
                [value]="batchProgress()"
                [striped]="true"
                [animated]="true"
                type="info"
                [showValue]="true"
                height="25px"
              ></ngb-progressbar>
            </div>
          } @else {
            <span>Processing...</span>
          }
        </div>
      }

      <!-- Batch Processing Details (show during and after batch processing) -->
      @if (isBatchMode() && batchFiles().length > 0) {
        <section class="batch-details" aria-labelledby="batch-heading">
          <div class="batch-header">
            <h3 id="batch-heading" class="batch-heading">Batch Processing Status</h3>
            <button
              class="batch-toggle-button"
              (click)="isBatchDetailsCollapsed.set(!isBatchDetailsCollapsed())"
              [attr.aria-expanded]="!isBatchDetailsCollapsed()"
              appTooltip="Toggle batch details"
              appTooltipPlacement="top"
            >
              {{ isBatchDetailsCollapsed() ? '‚ñº Show Details' : '‚ñ≤ Hide Details' }}
            </button>
          </div>
          <div [ngbCollapse]="isBatchDetailsCollapsed()">
            <div class="batch-files-list">
            @for (batchFile of batchFiles(); track $index) {
              <div class="batch-file-item" [class]="'status-' + batchFile.status">
                <div class="batch-file-info">
                  <span class="batch-file-name">{{ batchFile.file.name }}</span>
                  <span class="batch-file-status-icon" [attr.aria-label]="'Status: ' + batchFile.status">
                    @if (batchFile.status === BatchFileStatus.PENDING) { ‚è≥ }
                    @if (batchFile.status === BatchFileStatus.PROCESSING) { üîÑ }
                    @if (batchFile.status === BatchFileStatus.SUCCESS) { ‚úÖ }
                    @if (batchFile.status === BatchFileStatus.ERROR) { ‚ùå }
                  </span>
                </div>
                @if (batchFile.status === BatchFileStatus.PROCESSING) {
                  <div class="batch-file-progress">
                    <ngb-progressbar
                      [value]="batchFile.progress || 0"
                      [striped]="true"
                      [animated]="true"
                      type="primary"
                      [showValue]="true"
                      height="20px"
                    ></ngb-progressbar>
                  </div>
                }
                @if (batchFile.status === BatchFileStatus.ERROR) {
                  <div class="batch-file-error">
                    <span class="error-text">{{ batchFile.error }}</span>
                    <button
                      class="retry-button btn btn-sm btn-warning"
                      (click)="retryFile($index)"
                      [disabled]="isProcessing()"
                      aria-label="Retry processing this file"
                      appTooltip="Retry processing"
                      appTooltipPlacement="top"
                    >
                      üîÑ Retry
                    </button>
                  </div>
                }
                @if (batchFile.status === BatchFileStatus.SUCCESS && batchFile.events) {
                  <span class="batch-file-events-count">{{ batchFile.events.length }} event(s) extracted</span>
                }
              </div>
            }
          </div>
          </div>
        </section>
      }
    }

    <!-- Extracted Events - Apple Calendar Style with Editing -->
    @if (extractedEvents().length > 0) {
      <!-- Primary Action Button - Prominent Position -->
      <div class="primary-actions">
        <button
          class="action-button calendar-view btn btn-primary"
          (click)="openCalendarView()"
          aria-label="Open interactive calendar view"
          appTooltip="View and edit events in an interactive calendar"
          appTooltipPlacement="top"
        >
          üìÖ View Calendar
        </button>
      </div>

      <section class="events-list" aria-labelledby="events-heading">
        <h3 id="events-heading" class="sr-only">Extracted Calendar Events</h3>
        <div ngbAccordion class="events-accordion">
          @for (event of extractedEvents(); track $index) {
            <div ngbAccordionItem class="event-accordion-item">
              <h2 ngbAccordionHeader>
                <button ngbAccordionButton class="event-accordion-header">
                  <div class="event-accordion-header-content">
                    <div class="event-date" aria-hidden="true">
                      <div class="date-block">
                        <span [innerHTML]="getMonthDay(event.start)"></span>
                      </div>
                    </div>
                    <div class="event-header-main">
                      <h4 class="event-title">{{ event.summary }}</h4>
                      @if (event.location) {
                        <div class="event-location-header">
                          <span>üìç {{ event.location }}</span>
                        </div>
                      }
                    </div>
                    <div class="event-times-header">
                      <time class="event-time-start" [attr.datetime]="event.start">{{ getTime(event.start) }}</time>
                      @if (event.end && getTime(event.end)) {
                        <time class="event-time-end" [attr.datetime]="event.end">{{ getTime(event.end) }}</time>
                      }
                    </div>
                  </div>
                </button>
              </h2>
              <div ngbAccordionCollapse>
                <div ngbAccordionBody>
                  <ng-template>
                    @if (!event.isEditing) {
                      <!-- View Mode -->
                      <div class="event-details-body">
                        @if (event.location) {
                          <div class="event-detail-row">
                            <span class="detail-label">üìç Location:</span>
                            <span class="detail-value">{{ event.location }}</span>
                          </div>
                        }
                        @if (event.description) {
                          <div class="event-detail-row">
                            <span class="detail-label">üìù Description:</span>
                            <span class="detail-value">{{ event.description }}</span>
                          </div>
                        }
                        <div class="event-detail-row">
                          <span class="detail-label">üïí Start:</span>
                          <span class="detail-value">{{ event.start | date:'short' }}</span>
                        </div>
                        <div class="event-detail-row">
                          <span class="detail-label">üïì End:</span>
                          <span class="detail-value">{{ event.end | date:'short' }}</span>
                        </div>
                        <div class="event-actions-buttons">
                          <button
                            class="action-button-small edit btn btn-sm btn-info"
                            (click)="editEvent($index)"
                            aria-label="Edit event"
                            appTooltip="Edit this event"
                            appTooltipPlacement="top"
                          >
                            ‚úèÔ∏è Edit
                          </button>
                          <button
                            class="action-button-small delete btn btn-sm btn-danger"
                            (click)="deleteEvent($index)"
                            aria-label="Delete event"
                            appTooltip="Delete this event"
                            appTooltipPlacement="top"
                          >
                            üóëÔ∏è Delete
                          </button>
                        </div>
                      </div>
                    }
                    @if (event.isEditing) {
                      <!-- Edit Mode -->
                      <div class="event-edit-form">
                <div class="form-group">
                  <label for="summary-{{$index}}">Event Title</label>
                  <input
                    id="summary-{{$index}}"
                    type="text"
                    class="form-input"
                    [value]="event.summary"
                    (input)="updateEventField($index, 'summary', $any($event.target).value)"
                    placeholder="Event title"
                  />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="start-{{$index}}">Start</label>
                    <input
                      id="start-{{$index}}"
                      type="datetime-local"
                      class="form-input"
                      [value]="formatDateForInput(event.start)"
                      (input)="updateEventField($index, 'start', parseDateFromInput($any($event.target).value))"
                    />
                  </div>
                  <div class="form-group">
                    <label for="end-{{$index}}">End</label>
                    <input
                      id="end-{{$index}}"
                      type="datetime-local"
                      class="form-input"
                      [value]="formatDateForInput(event.end)"
                      (input)="updateEventField($index, 'end', parseDateFromInput($any($event.target).value))"
                    />
                  </div>
                </div>

                <div class="form-group">
                  <label for="location-{{$index}}">Location</label>
                  <input
                    id="location-{{$index}}"
                    type="text"
                    class="form-input"
                    [value]="event.location || ''"
                    (input)="updateEventField($index, 'location', $any($event.target).value)"
                    placeholder="Event location (optional)"
                  />
                </div>

                <div class="form-group">
                  <label for="description-{{$index}}">Description</label>
                  <textarea
                    id="description-{{$index}}"
                    class="form-input"
                    rows="3"
                    [value]="event.description || ''"
                    (input)="updateEventField($index, 'description', $any($event.target).value)"
                    placeholder="Event description (optional)"
                  ></textarea>
                </div>

                <div class="form-actions">
                  <button
                    class="form-button save btn btn-success"
                    (click)="saveEvent($index)"
                    aria-label="Save changes"
                    appTooltip="Save event changes"
                    appTooltipPlacement="top"
                  >
                    üíæ Save
                  </button>
                  <button
                    class="form-button cancel btn btn-secondary"
                    (click)="cancelEdit($index)"
                    aria-label="Cancel editing"
                    appTooltip="Cancel without saving"
                    appTooltipPlacement="top"
                  >
                    ‚úï Cancel
                  </button>
                </div>
                      </div>
                    }
                  </ng-template>
                </div>
              </div>
            </div>
          }
        </div>
      </section>

      <!-- Action Buttons -->
      <nav class="actions" aria-label="Calendar actions">
        <button
          class="action-button calendar-view btn btn-primary"
          (click)="openCalendarView()"
          aria-label="Open interactive calendar view"
          appTooltip="View and edit events in an interactive calendar"
          appTooltipPlacement="top"
        >
          üìÖ View Calendar
        </button>
        <button
          class="action-button download btn btn-success"
          (click)="downloadIcs()"
          aria-label="Download calendar file"
          appTooltip="Download your calendar as .ics file"
          appTooltipPlacement="top"
        >
          Download Calendar
        </button>
        <button
          class="action-button secondary btn btn-secondary"
          (click)="resetState()"
          aria-label="Convert another file"
          appTooltip="Start over with new files"
          appTooltipPlacement="top"
        >
          Convert Another
        </button>
      </nav>
    }
  }
</app-card>

<!-- Calendar View Modal - Outside card for full-width display -->
<app-calendar-view
  [events]="extractedEvents()"
  [visible]="isCalendarViewVisible()"
  (visibleChange)="handleCalendarVisibilityChange($event)"
  (eventsChange)="handleCalendarEventsChange($event)"
  (exportIcs)="handleCalendarExport()"
/>
