<app-card id="converter" title="üìÖ Calendar Converter App">
  <!-- Auth Required Message (when not authenticated) -->
  @if (!isAuthLoading && !isAuthenticated) {
    <section class="auth-required" aria-labelledby="auth-heading">
      <div class="auth-message">
        <h3 id="auth-heading" class="sr-only">AI Calendar Converter</h3>
        <p>
          Upload or snap your appointments, and AI turns them into calendar-ready events.
        </p>
        <img src="/assets/images/converter.png" alt="Calendar converter illustration" class="auth-image" loading="lazy" />
      </div>
      <button class="sign-in-button" (click)="signIn()" aria-label="Sign in with Google to use converter">
        üîê Sign in with Google
      </button>
    </section>
  }

  <!-- Loading State -->
  @if (isAuthLoading) {
    <div class="auth-loading" role="status" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <p>Loading...</p>
    </div>
  }

  <!-- Converter UI (only shown when authenticated) -->
  @if (!isAuthLoading && isAuthenticated) {
    <!-- Upload Area - Only show if no events extracted -->
    @if (extractedEvents().length === 0) {
      <section class="upload-zone"
        [class.dragging]="isDragging()"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
        role="region"
        aria-labelledby="upload-heading"
      >
        <p>Save time creating calendar appointments.</p>
        <p>AI will do the work for you!</p>
        <ol class="upload-steps" aria-label="How it works">
          <li>Upload photos, images, or PDFs of your events.</li>
          <li>AI converts them into calendar-ready events.</li>
          <li>Review and edit extracted events.</li>
          <li>Download and import into your device.</li>
        </ol>
        <div class="upload-icon" aria-hidden="true">üì§</div>
        <h3 id="upload-heading" class="sr-only">Upload Files</h3>
        <p>Drop files here or</p>
        <label class="upload-button">
          <input
            type="file"
            class="file-input"
            multiple
            accept="image/jpeg,image/jpg,image/png,application/pdf"
            (change)="onFileSelect($event)"
            [disabled]="isProcessing()"
            aria-label="Select files to upload"
          />
          <span>Browse</span>
        </label>
      </section>

      <!-- Selected Files - Minimalist -->
      @if (files().length > 0) {
        <div class="selected-files" role="list" aria-label="Selected files">
          @for (file of files(); track $index) {
            <div class="file-chip" role="listitem">
              <span>{{ file.name }}</span>
              <button
                class="chip-remove"
                (click)="removeFile($index)"
                [disabled]="isProcessing()"
                [attr.aria-label]="'Remove ' + file.name"
              >
                ‚úï
              </button>
            </div>
          }
        </div>
      }

      <!-- Convert Button -->
      @if (files().length > 0 && !isProcessing()) {
        <button class="action-button" (click)="convertToIcs()" aria-label="Convert files to calendar events">
          Convert
        </button>
      }

      @if (isProcessing()) {
        <div class="processing" role="status" aria-live="polite">
          <span class="spinner" aria-hidden="true"></span>
          @if (isBatchMode()) {
            <div class="batch-processing">
              <span>Processing files: {{ batchStats().processing + batchStats().success }} / {{ batchStats().total }}</span>
              <div class="batch-progress-bar">
                <div class="batch-progress-fill" [style.width.%]="batchProgress()"></div>
              </div>
            </div>
          } @else {
            <span>Processing...</span>
          }
        </div>
      }

      <!-- Batch Processing Details (show during and after batch processing) -->
      @if (isBatchMode() && batchFiles().length > 0) {
        <section class="batch-details" aria-labelledby="batch-heading">
          <h3 id="batch-heading" class="sr-only">Batch Processing Status</h3>
          <div class="batch-files-list">
            @for (batchFile of batchFiles(); track $index) {
              <div class="batch-file-item" [class]="'status-' + batchFile.status">
                <div class="batch-file-info">
                  <span class="batch-file-name">{{ batchFile.file.name }}</span>
                  <span class="batch-file-status-icon" [attr.aria-label]="'Status: ' + batchFile.status">
                    @if (batchFile.status === BatchFileStatus.PENDING) { ‚è≥ }
                    @if (batchFile.status === BatchFileStatus.PROCESSING) { üîÑ }
                    @if (batchFile.status === BatchFileStatus.SUCCESS) { ‚úÖ }
                    @if (batchFile.status === BatchFileStatus.ERROR) { ‚ùå }
                  </span>
                </div>
                @if (batchFile.status === BatchFileStatus.PROCESSING) {
                  <div class="batch-file-progress">
                    <div class="batch-file-progress-bar">
                      <div class="batch-file-progress-fill" [style.width.%]="batchFile.progress"></div>
                    </div>
                  </div>
                }
                @if (batchFile.status === BatchFileStatus.ERROR) {
                  <div class="batch-file-error">
                    <span class="error-text">{{ batchFile.error }}</span>
                    <button class="retry-button" (click)="retryFile($index)" [disabled]="isProcessing()" aria-label="Retry processing this file">
                      üîÑ Retry
                    </button>
                  </div>
                }
                @if (batchFile.status === BatchFileStatus.SUCCESS && batchFile.events) {
                  <span class="batch-file-events-count">{{ batchFile.events.length }} event(s) extracted</span>
                }
              </div>
            }
          </div>
        </section>
      }
    }

    <!-- Error Message -->
    @if (errorMessage()) {
      <div class="alert error" role="alert" aria-live="assertive">
        {{ errorMessage() }}
      </div>
    }

    <!-- Extracted Events - Apple Calendar Style with Editing -->
    @if (extractedEvents().length > 0) {
      <section class="events-list" aria-labelledby="events-heading">
        <h3 id="events-heading" class="sr-only">Extracted Calendar Events</h3>
        @for (event of extractedEvents(); track $index) {
          <article class="event-item" [class.editing]="event.isEditing" [class.show-actions]="event.showActions" [attr.aria-label]="'Event: ' + event.summary">
            <!-- View Mode -->
            @if (!event.isEditing) {
              <div class="event-card"
                (click)="toggleEventActions($index)"
                (keydown.enter)="toggleEventActions($index)"
                (keydown.space)="toggleEventActions($index)"
                tabindex="0"
                role="button"
                [attr.aria-expanded]="event.showActions"
                aria-label="Toggle event actions">
                <div class="event-date" aria-hidden="true">
                  <div class="date-block">
                    <span [innerHTML]="getMonthDay(event.start)"></span>
                  </div>
                </div>
                <div class="event-details">
                  <div class="event-content">
                    <h4 class="event-title">{{ event.summary }}</h4>
                    <div class="event-location">
                      @if (event.location) {
                        <span aria-label="Location">üìç {{ event.location }}</span>
                      }
                    </div>
                  </div>
                  <div class="event-times">
                    <time class="event-time" [attr.datetime]="event.start">{{ getTime(event.start) }}</time>
                    @if (event.end && getTime(event.end)) {
                      <time class="event-time-end" [attr.datetime]="event.end">{{ getTime(event.end) }}</time>
                    }
                  </div>
                </div>
              </div>
              <!-- Action Menu (shown on click) -->
              @if (event.showActions) {
                <div class="event-actions-menu"
                  (click)="$event.stopPropagation()"
                  (keydown.enter)="$event.stopPropagation()"
                  (keydown.space)="$event.stopPropagation()"
                  tabindex="-1"
                  role="menu"
                  aria-label="Event actions">
                  <button class="action-menu-button edit" (click)="editEvent($index)" role="menuitem" aria-label="Edit event">
                    ‚úèÔ∏è Edit
                  </button>
                  <button class="action-menu-button delete" (click)="deleteEvent($index)" role="menuitem" aria-label="Delete event">
                    üóëÔ∏è Delete
                  </button>
                </div>
              }
            }

            <!-- Edit Mode -->
            @if (event.isEditing) {
              <div class="event-edit-form">
                <div class="form-group">
                  <label for="summary-{{$index}}">Event Title</label>
                  <input
                    id="summary-{{$index}}"
                    type="text"
                    class="form-input"
                    [value]="event.summary"
                    (input)="updateEventField($index, 'summary', $any($event.target).value)"
                    placeholder="Event title"
                  />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="start-{{$index}}">Start</label>
                    <input
                      id="start-{{$index}}"
                      type="datetime-local"
                      class="form-input"
                      [value]="formatDateForInput(event.start)"
                      (input)="updateEventField($index, 'start', parseDateFromInput($any($event.target).value))"
                    />
                  </div>
                  <div class="form-group">
                    <label for="end-{{$index}}">End</label>
                    <input
                      id="end-{{$index}}"
                      type="datetime-local"
                      class="form-input"
                      [value]="formatDateForInput(event.end)"
                      (input)="updateEventField($index, 'end', parseDateFromInput($any($event.target).value))"
                    />
                  </div>
                </div>

                <div class="form-group">
                  <label for="location-{{$index}}">Location</label>
                  <input
                    id="location-{{$index}}"
                    type="text"
                    class="form-input"
                    [value]="event.location || ''"
                    (input)="updateEventField($index, 'location', $any($event.target).value)"
                    placeholder="Event location (optional)"
                  />
                </div>

                <div class="form-group">
                  <label for="description-{{$index}}">Description</label>
                  <textarea
                    id="description-{{$index}}"
                    class="form-input"
                    rows="3"
                    [value]="event.description || ''"
                    (input)="updateEventField($index, 'description', $any($event.target).value)"
                    placeholder="Event description (optional)"
                  ></textarea>
                </div>

                <div class="form-actions">
                  <button class="form-button save" (click)="saveEvent($index)" aria-label="Save changes">
                    üíæ Save
                  </button>
                  <button class="form-button cancel" (click)="cancelEdit($index)" aria-label="Cancel editing">
                    ‚úï Cancel
                  </button>
                </div>
              </div>
            }
          </article>
        }
      </section>

      <!-- Download Button -->
      <nav class="actions" aria-label="Calendar actions">
        <button class="action-button download" (click)="downloadIcs()" aria-label="Download calendar file">
          Download Calendar
        </button>
        <button class="action-button secondary" (click)="resetState()" aria-label="Convert another file">
          Convert Another
        </button>
      </nav>
    }
  }
</app-card>
